{
  "Description": " - AWS Glue connections and jobs",
  "Parameters": {
    "ApplicationID": {
      "Description": "Application ID",
      "Type": "String",
      "AllowedPattern": "[-a-z0-9]+",
      "MaxLength": 50
    },
    "InfrastructureID": {
      "Description": "Infrastructure ID",
      "Type": "String",
      "AllowedPattern": "[-a-z0-9]+",
      "MaxLength": 50
    },
    "GlueIAMRole": {
      "Description": "IAM Role for AWS Glue",
      "Type": "String",
      "Default": "AWSGlueServiceRoleDefault"
    },
    "DBUser": {
      "Description": "Aurora MySQL database master user",
      "Type": "String"
    },
    "DBPassword": {
      "Description": "Aurora MySQL database master user password",
      "Type": "String",
      "MinLength": 8
    },
    "SQLScriptS3BucketName": {
      "Description": "Bucket containing SQL script",
      "Type": "String"
    },
    "SQLScriptS3Key": {
      "Description": "SQL script S3 key",
      "Type": "String"
    },
    "S3ExportPath": {
      "Description": "S3 output path for exported CSV files",
      "Type": "String",
      "AllowedPattern": "^s3://.*/$"
    }
  },
  "Resources": {
    "SalesDatabase": {
      "Type": "AWS::Glue::Database",
      "Properties": {
        "DatabaseInput": {
          "Name": {
            "Fn::Sub": "${ApplicationID}_salesdb"
          }
        },
        "CatalogId": {
          "Ref": "AWS::AccountId"
        }
      }
    },
    "AuroraMySQLConnection": {
      "Type": "AWS::Glue::Connection",
      "Properties": {
        "ConnectionInput": {
          "Description": "Aurora MySQL Connection",
          "ConnectionType": "JDBC",
          "MatchCriteria": [

          ],
          "PhysicalConnectionRequirements": {
            "AvailabilityZone": {
              "Fn::Select": [
                0,
                {
                  "Fn::GetAZs": ""
                }
              ]
            },
            "SecurityGroupIdList": [
              {
                "Fn::ImportValue": {
                  "Fn::Sub": "${InfrastructureID}-DefaultSecurityGroup"
                }
              },
              {
                "Fn::ImportValue": {
                  "Fn::Sub": "${InfrastructureID}-RDSSecurityGroup"
                }
              }
            ],
            "SubnetId": {
              "Fn::Select": [
                0,
                {
                  "Fn::Split": [
                    ",",
                    {
                      "Fn::ImportValue": {
                        "Fn::Sub": "${InfrastructureID}-PrivateSubnetIDs"
                      }
                    }
                  ]
                }
              ]
            }
          },
          "ConnectionProperties": {
            "USERNAME": {
              "Ref": "DBUser"
            },
            "JDBC_ENFORCE_SSL": "true",
            "PASSWORD": {
              "Ref": "DBPassword"
            },
            "JDBC_CONNECTION_URL": {
              "Fn::ImportValue": {
                "Fn::Sub": "${ApplicationID}-AuroraMySQLJDBCURL"
              }
            }
          },
          "Name": {
            "Fn::Sub": "${ApplicationID}-mysql-connection"
          }
        },
        "CatalogId": {
          "Ref": "AWS::AccountId"
        }
      }
    },
    "NeptuneConnection": {
      "Type": "AWS::Glue::Connection",
      "Properties": {
        "ConnectionInput": {
          "Description": "Neptune Connection",
          "ConnectionType": "JDBC",
          "MatchCriteria": [

          ],
          "PhysicalConnectionRequirements": {
            "AvailabilityZone": {
              "Fn::Select": [
                0,
                {
                  "Fn::GetAZs": ""
                }
              ]
            },
            "SecurityGroupIdList": [
              {
                "Fn::ImportValue": {
                  "Fn::Sub": "${InfrastructureID}-DefaultSecurityGroup"
                }
              },
              {
                "Fn::ImportValue": {
                  "Fn::Sub": "${InfrastructureID}-NeptuneSecurityGroup"
                }
              }
            ],
            "SubnetId": {
              "Fn::Select": [
                0,
                {
                  "Fn::Split": [
                    ",",
                    {
                      "Fn::ImportValue": {
                        "Fn::Sub": "${InfrastructureID}-PrivateSubnetIDs"
                      }
                    }
                  ]
                }
              ]
            }
          },
          "ConnectionProperties": {
            "USERNAME": "neptune",
            "JDBC_ENFORCE_SSL": "true",
            "PASSWORD": "neptune",
            "JDBC_CONNECTION_URL": {
              "Fn::Join": [
                "",
                [
                  "jdbc:",
                  {
                    "Fn::ImportValue": {
                      "Fn::Sub": "${ApplicationID}-NeptuneGremlinEndpoint"
                    }
                  }
                ]
              ]
            }
          },
          "Name": {
            "Fn::Sub": "${ApplicationID}-neptune-connection"
          }
        },
        "CatalogId": {
          "Ref": "AWS::AccountId"
        }
      }
    },
    "LoadMySQLJob": {
      "Type": "AWS::Glue::Job",
      "Properties": {
        "Role": {
          "Ref": "GlueIAMRole"
        },
        "DefaultArguments": {
          "--job-language": "python",
          "--job-bookmark-option": "job-bookmark-disable",
          "--CONNECTION_NAME": {
            "Ref": "AuroraMySQLConnection"
          },
          "--BUCKET_NAME": {
            "Ref": "SQLScriptS3BucketName"
          },
          "--KEY": {
            "Ref": "SQLScriptS3Key"
          }
        },
        "Connections": {
          "Connections": [
            {
              "Ref": "AuroraMySQLConnection"
            }
          ]
        },
        "MaxRetries": 0,
        "Description": "Load Aurora MySQL with salesdb data",
        "Command": {
          "ScriptLocation": {
            "Fn::Sub": "s3://ianrob-examples-${AWS::Region}/etl/common/load_mysql.py"
          },
          "Name": "glueetl"
        },
        "AllocatedCapacity": 2,
        "ExecutionProperty": {
          "MaxConcurrentRuns": 1
        },
        "Name": {
          "Fn::Sub": "${ApplicationID}_load_salesdb"
        }
      }
    },
    "SalesDatabaseCrawler": {
      "Type": "AWS::Glue::Crawler",
      "Properties": {
        "Role": {
          "Ref": "GlueIAMRole"
        },
        "Description": "Sales DB crawler",
        "DatabaseName": {
          "Ref": "SalesDatabase"
        },
        "Targets": {
          "JdbcTargets": [
            {
              "ConnectionName": {
                "Ref": "AuroraMySQLConnection"
              },
              "Path": "salesdb/%"
            }
          ]
        },
        "TablePrefix": {
          "Fn::Sub": "${ApplicationID}_"
        },
        "Name": {
          "Fn::Sub": "${ApplicationID}_salesdb_crawler"
        }
      }
    },
    "ExportFromMySQLToS3Job": {
      "Type": "AWS::Glue::Job",
      "Properties": {
        "Role": {
          "Ref": "GlueIAMRole"
        },
        "DefaultArguments": {
          "--job-language": "python",
          "--extra-py-files": {
            "Fn::Sub": "s3://ianrob-examples-${AWS::Region}/etl/mysql-neptune/glue_neptune.zip"
          },
          "--job-bookmark-option": "job-bookmark-disable",
          "--S3_OUTPUT_PATH": {
            "Ref": "S3ExportPath"
          },
          "--DATABASE_NAME": {
            "Ref": "SalesDatabase"
          },
          "--TABLE_PREFIX": {
            "Fn::Sub": "${ApplicationID}_"
          }
        },
        "Connections": {
          "Connections": [
            {
              "Ref": "AuroraMySQLConnection"
            }
          ]
        },
        "MaxRetries": 0,
        "Description": "Export CSV data from MySQL to S3",
        "Command": {
          "ScriptLocation": {
            "Fn::Sub": "s3://ianrob-examples-${AWS::Region}/etl/mysql-neptune/export-from-mysql-to-s3.py"
          },
          "Name": "glueetl"
        },
        "AllocatedCapacity": 2,
        "ExecutionProperty": {
          "MaxConcurrentRuns": 1
        },
        "Name": {
          "Fn::Sub": "${ApplicationID}_export_from_mysql_to_s3"
        }
      }
    },
    "ExportFromMySQLToNeptuneJob": {
      "Type": "AWS::Glue::Job",
      "Properties": {
        "Role": {
          "Ref": "GlueIAMRole"
        },
        "DefaultArguments": {
          "--job-language": "python",
          "--extra-py-files": {
            "Fn::Sub": "s3://ianrob-examples-${AWS::Region}/etl/mysql-neptune/glue_neptune.zip"
          },
          "--job-bookmark-option": "job-bookmark-disable",
          "--DATABASE_NAME": {
            "Ref": "SalesDatabase"
          },
          "--TABLE_PREFIX": {
            "Fn::Sub": "${ApplicationID}_"
          },
          "--NEPTUNE_CONNECTION_NAME": {
            "Ref": "NeptuneConnection"
          }
        },
        "Connections": {
          "Connections": [
            {
              "Ref": "AuroraMySQLConnection"
            },
            {
              "Ref": "NeptuneConnection"
            }
          ]
        },
        "MaxRetries": 0,
        "Description": "Export data from MySQL to Neptune",
        "Command": {
          "ScriptLocation": {
            "Fn::Sub": "s3://ianrob-examples-${AWS::Region}/etl/mysql-neptune/export-from-mysql-to-neptune.py"
          },
          "Name": "glueetl"
        },
        "AllocatedCapacity": 2,
        "ExecutionProperty": {
          "MaxConcurrentRuns": 1
        },
        "Name": {
          "Fn::Sub": "${ApplicationID}_export_from_mysql_to_neptune"
        }
      }
    },
    "ExportFromMySQLToNeptuneIncrementalJob": {
      "Type": "AWS::Glue::Job",
      "Properties": {
        "Role": {
          "Ref": "GlueIAMRole"
        },
        "DefaultArguments": {
          "--job-language": "python",
          "--extra-py-files": {
            "Fn::Sub": "s3://ianrob-examples-${AWS::Region}/etl/mysql-neptune/glue_neptune.zip"
          },
          "--job-bookmark-option": "job-bookmark-disable",
          "--DATABASE_NAME": {
            "Ref": "SalesDatabase"
          },
          "--TABLE_PREFIX": {
            "Fn::Sub": "${ApplicationID}_"
          },
          "--NEPTUNE_CONNECTION_NAME": {
            "Ref": "NeptuneConnection"
          }
        },
        "Connections": {
          "Connections": [
            {
              "Ref": "AuroraMySQLConnection"
            },
            {
              "Ref": "NeptuneConnection"
            }
          ]
        },
        "MaxRetries": 0,
        "Description": "Incremental export of data from MySQL to Neptune",
        "Command": {
          "ScriptLocation": {
            "Fn::Sub": "s3://ianrob-examples-${AWS::Region}/etl/mysql-neptune/export-from-mysql-to-neptune-incremental.py"
          },
          "Name": "glueetl"
        },
        "AllocatedCapacity": 2,
        "ExecutionProperty": {
          "MaxConcurrentRuns": 1
        },
        "Name": {
          "Fn::Sub": "${ApplicationID}_export_from_mysql_to_neptune_incremental"
        }
      }
    }
  },
  "Outputs": {
  }
}